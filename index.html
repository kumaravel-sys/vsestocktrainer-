<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VSE Stock Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- ✅ Use only compat version -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; text-align:center; margin:0; padding:20px; }
    .card { background:#222; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.5); max-width:400px; margin:20px auto; }
    input,button { padding:8px; margin:5px; border-radius:6px; border:none; }
    button { cursor:pointer; background:#0a84ff; color:white; }
    #portfolioTable { margin:auto; border-collapse:collapse; }
    #portfolioTable th, #portfolioTable td { border:1px solid #444; padding:8px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>📈 VSE Stock Trainer</h1>

  <!-- Auth Card -->
  <div class="card" id="authCard">
    <h3>Login / Sign up</h3>
    <input type="email" id="email" placeholder="Email (for Firebase login)" /><br>
    <input type="password" id="password" placeholder="Password" /><br>
    <button id="btnSignup">Sign Up</button>
    <button id="btnSignin">Sign In</button>
    <button id="btnSignout" class="hidden">Sign Out</button>
    <hr>
    <button id="btnGuest">Continue as Guest</button>
    <button id="btnCommon">Enter Common Password</button>
    <p id="authMsg"></p>
  </div>

  <!-- Portfolio -->
  <div class="card hidden" id="portfolioCard">
    <h3>Your Portfolio</h3>
    <p>Balance: $<span id="balance">0</span></p>
    <table id="portfolioTable">
      <thead><tr><th>Symbol</th><th>Shares</th></tr></thead>
      <tbody id="portfolioBody"></tbody>
    </table>
    <hr>
    <input id="symbol" placeholder="Symbol (AAPL)" />
    <input id="qty" type="number" placeholder="Qty" />
    <button id="btnBuy">Buy</button>
    <button id="btnSell">Sell</button>
    <p id="tradeMsg"></p>
  </div>

  <!-- Admin -->
  <div class="card hidden" id="adminCard">
    <h3>Admin Panel</h3>
    <p>Only visible for admin accounts</p>
    <div id="adminUsers"></div>
  </div>

<script>
  // ✅ Firebase Config (only once)
  const firebaseConfig = {
    apiKey: "AIzaSyDue5h7wX-64R_DhSdcTpcm9sY7HGmPCE8",
    authDomain: "sharetrainer-3b31d.firebaseapp.com",
    projectId: "sharetrainer-3b31d",
    storageBucket: "sharetrainer-3b31d.appspot.com",
    messagingSenderId: "838629172577",
    appId: "1:838629172577:web:95bb0d1aa0d945e59e1120"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------------- Globals ----------------
  let currentUser = null;
  const START_BALANCE = 100000;
  const COMMON_PASSWORD = "vse2k25";
  const ADMIN_EMAIL = "admin6@vse.com";
  const ADMIN_PASSWORD = "adminvse2k25";

  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const authMsg = document.getElementById('authMsg');
  function setAuthMsg(msg){ authMsg.textContent = msg; }

  // ---------------- Auth Handlers ----------------
  document.getElementById('btnSignup').onclick = async () => {
    try { await auth.createUserWithEmailAndPassword(emailEl.value, passEl.value); }
    catch(e){ setAuthMsg(e.message); }
  };
  document.getElementById('btnSignin').onclick = async () => {
    try { await auth.signInWithEmailAndPassword(emailEl.value, passEl.value); }
    catch(e){ setAuthMsg(e.message); }
  };
  document.getElementById('btnSignout').onclick = () => auth.signOut();
  document.getElementById('btnGuest').onclick = async () => {
    try { await auth.signInAnonymously(); }
    catch(e){ setAuthMsg(e.message); }
  };
  document.getElementById('btnCommon').onclick = async () => {
    const pass = passEl.value.trim();
    if (pass !== COMMON_PASSWORD) return setAuthMsg("❌ Wrong common password");
    try { await auth.signInAnonymously(); setAuthMsg("✅ Signed in with common password"); }
    catch(e){ setAuthMsg(e.message); }
  };

  // ---------------- Auth State ----------------
  auth.onAuthStateChanged(async user => {
    if (!user) {
      currentUser = null;
      document.getElementById('portfolioCard').classList.add('hidden');
      document.getElementById('adminCard').classList.add('hidden');
      document.getElementById('btnSignout').classList.add('hidden');
      return;
    }
    currentUser = user;
    document.getElementById('btnSignout').classList.remove('hidden');
    setAuthMsg("Signed in as " + (user.email || "Guest"));

    // init user doc
    const ref = db.collection('users').doc(user.uid);
    const snap = await ref.get();
    if (!snap.exists) {
      await ref.set({ balance: START_BALANCE, portfolio: {} });
    }
    watchPortfolio(user.uid);

    // check admin
    const adminSnap = await db.collection('admins').doc(user.uid).get();
    if (adminSnap.exists && adminSnap.data().admin) {
      document.getElementById('adminCard').classList.remove('hidden');
      loadAdminPanel();
    } else {
      document.getElementById('adminCard').classList.add('hidden');
    }
  });

  // ---------------- Portfolio ----------------
  function watchPortfolio(uid) {
    db.collection('users').doc(uid).onSnapshot(doc => {
      const data = doc.data();
      document.getElementById('portfolioCard').classList.remove('hidden');
      document.getElementById('balance').textContent = data.balance.toFixed(2);
      const tbody = document.getElementById('portfolioBody');
      tbody.innerHTML = "";
      for (const [sym, qty] of Object.entries(data.portfolio)) {
        const row = `<tr><td>${sym}</td><td>${qty}</td></tr>`;
        tbody.innerHTML += row;
      }
    });
  }

  async function getPrice(symbol) {
    const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=d3bm7n1r01qqg7bv706gd3bm7n1r01qqg7bv7070`;
    const r = await fetch(url); const j = await r.json();
    return j.c || 0;
  }

  async function trade(action) {
    const symbol = document.getElementById('symbol').value.toUpperCase();
    const qty = parseInt(document.getElementById('qty').value);
    if (!symbol || qty <= 0) return;
    const price = await getPrice(symbol);
    if (!price) return setTradeMsg("No price for " + symbol);

    const ref = db.collection('users').doc(currentUser.uid);
    await db.runTransaction(async tx => {
      const snap = await tx.get(ref);
      let bal = snap.data().balance;
      let port = snap.data().portfolio || {};
      if (action==="buy") {
        const cost = price*qty;
        if (bal<cost) throw "Insufficient balance";
        bal -= cost; port[symbol]=(port[symbol]||0)+qty;
      } else {
        const have = port[symbol]||0;
        if (have<qty) throw "Not enough shares";
        port[symbol]=have-qty; if(port[symbol]<=0) delete port[symbol];
        bal += price*qty;
      }
      tx.set(ref,{balance:bal,portfolio:port});
    });
    setTradeMsg("✅ " + action.toUpperCase()+" " + qty + " " + symbol + " @"+price);
  }
  document.getElementById('btnBuy').onclick=()=>trade("buy");
  document.getElementById('btnSell').onclick=()=>trade("sell");
  function setTradeMsg(msg){ document.getElementById('tradeMsg').textContent=msg; }

  // ---------------- Admin ----------------
  async function loadAdminPanel() {
    const cont=document.getElementById('adminUsers'); cont.innerHTML="";
    const snaps=await db.collection('users').get();
    snaps.forEach(doc=>{
      const d=doc.data();
      cont.innerHTML+=`<p><b>${doc.id}</b> – Balance: ${d.balance}</p>`;
    });
  }
</script>
</body>
</html>
